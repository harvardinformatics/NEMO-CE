stages:
  - test
  - build
  - deploy

variables:
  GIT_STRATEGY: clone

.test: &test
  stage: test
  script:
    - python -m pip install ./
    - python ./run_tests.py

Test python 3.9:
  <<: *test
  image: python:3.9

Test python 3.10:
  <<: *test
  image: python:3.10

Test python 3.11:
  <<: *test
  image: python:3.11

Test python 3.12:
  <<: *test
  image: python:3.12

Test python 3.13:
  <<: *test
  image: python:3.13

NEMO-CE dev build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker login --username $CI_REGISTRY_USER --password $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build --tag $CI_REGISTRY_IMAGE:dev .
    - docker push $CI_REGISTRY_IMAGE:dev
    - docker logout
  only:
    - schedules
    - master

NEMO-CE Release:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker login --username $CI_REGISTRY_USER --password $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build --tag $CI_REGISTRY_IMAGE${CI_COMMIT_TAG:+:}${CI_COMMIT_TAG:-} --tag $CI_REGISTRY_IMAGE:latest .
    - docker push $CI_REGISTRY_IMAGE${CI_COMMIT_TAG:+:}${CI_COMMIT_TAG:-}
    - docker push $CI_REGISTRY_IMAGE:latest
    - docker logout
  only:
    - tags

NEMO-CE PyPI Release:
  image: python:3
  stage: build
  script:
    - sed -i "s/^version =.*/version = '$(git describe --tags)'/" pyproject.toml
    - pip install --upgrade pip build twine
    - python -m build
    - twine upload --user $PYPI_USER --password $PYPI_PASSWORD ./dist/nemo_ce*
  only:
    - tags

NEMO-CE dev deploy:
  variables:
    GIT_STRATEGY: none
  stage: deploy
  script:
    - sudo bash -c 'cd /opt/nemo/ && docker pull registry.gitlab.com/nemo-community/nemo-ce:dev'
    - sudo bash -c 'cd /opt/nemo/ && docker compose up -d nemodev'
  only:
    - schedules
  tags: [centos-srv1-shell]
